version: 1.0.{build}

# Use Ubuntu image
image: Ubuntu2004

# Basic environment
environment:
  CMAKE_BUILD_TYPE: Release
  INSTALL_PREFIX: install

# Install dependencies including CUDA toolkit (nvcc)
install:
  - sudo apt-get update -y
  - sudo apt-get install -y build-essential git wget cmake
  # Install CMake that is compatible with cuSZp build process
  - sudo apt-get purge --auto-remove cmake -y
  - wget -q https://github.com/Kitware/CMake/releases/download/v3.27.9/cmake-3.27.9-linux-x86_64.tar.gz
  - tar -xzf cmake-3.27.9-linux-x86_64.tar.gz
  - sudo mv cmake-3.27.9-linux-x86_64 /opt/cmake
  - sudo ln -sf /opt/cmake/bin/* /usr/local/bin/
  - cmake --version
  # Install CUDA 12.2 (supports C++17)
  - wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.1-1_all.deb
  - sudo dpkg -i cuda-keyring_1.1-1_all.deb
  - sudo apt-get update -y
  - sudo apt-get install -y cuda-toolkit-12-2
  # Add CUDA to PATH and verify
  - echo 'export PATH=/usr/local/cuda-12.2/bin:$PATH' >> ~/.bashrc
  - source ~/.bashrc
  - export PATH=/usr/local/cuda-12.2/bin:$PATH
  - nvcc --version

# Build
build_script:
  - echo "=== Building cuSZp on Ubuntu ==="
  - cmake -S . -B build -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DCMAKE_INSTALL_PREFIX=${INSTALL_PREFIX}
  - cmake --build build -- -j"$(nproc)"
  - cmake --install build
