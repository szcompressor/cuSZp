version: 1.0.{build}

# Use Ubuntu image
image: Ubuntu2004

# Basic environment
environment:
  CMAKE_BUILD_TYPE: Release
  INSTALL_PREFIX: install

# Install dependencies including CUDA toolkit (nvcc)
install:
  - sudo apt-get update -y
  - sudo apt-get install -y build-essential cmake git nvidia-cuda-toolkit
  # Install CMake that is compatible with cuSZp build process
  - sudo apt-get purge --auto-remove cmake -y
  - wget -q https://github.com/Kitware/CMake/releases/download/v3.27.9/cmake-3.27.9-linux-x86_64.tar.gz
  - tar -xzf cmake-3.27.9-linux-x86_64.tar.gz
  - sudo mv cmake-3.27.9-linux-x86_64 /opt/cmake
  - sudo ln -sf /opt/cmake/bin/* /usr/local/bin/
  - cmake --version

# Build
build_script:
  - echo "=== Building cuSZp on Ubuntu ==="
  - cmake -S . -B build -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DCMAKE_INSTALL_PREFIX=${INSTALL_PREFIX}
  - cmake --build build -- -j"$(nproc)"
  - cmake --install build
